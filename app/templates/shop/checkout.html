{% extends "base.html" %}

{% block title %}Checkout - {{ package.name }}{% endblock %}

{% block extra_css %}
<style>
    body.dark-checkout {
        background-color: #0F172A !important;
        color: #f1f5f9;
    }
    body.dark-checkout .navbar, body.dark-checkout nav {
        background-color: #1E293B !important;
    }
    body.dark-checkout .card {
        background-color: #1E293B;
        border: 1px solid rgba(255,255,255,0.06);
        color: #f1f5f9;
    }
    body.dark-checkout .card-header {
        background-color: rgba(255,255,255,0.03);
        border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    body.dark-checkout .form-control,
    body.dark-checkout .form-select {
        background-color: #0F172A;
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
    }
    body.dark-checkout .form-check-label { color: #f1f5f9; }
    body.dark-checkout .modal-content {
        background-color: #1E293B;
        color: #f1f5f9;
    }

    /* Package preview */
    .checkout-package {
        background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
        border: 1px solid rgba(255,107,53,0.2);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        margin-bottom: 20px;
    }
    .checkout-package .pkg-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 4px;
    }
    .checkout-package .pkg-credits {
        font-size: 2.5rem;
        font-weight: 800;
        color: #FF6B35;
        line-height: 1;
    }
    .checkout-package .pkg-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #10B981;
        margin-top: 8px;
    }

    /* Payment method cards */
    .method-card {
        background: #0F172A;
        border: 2px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 16px 20px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 12px;
    }
    .method-card:hover { border-color: rgba(255,107,53,0.3); }
    .method-card.selected {
        border-color: #FF6B35;
        background: rgba(255,107,53,0.05);
    }
    .method-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .method-card .method-radio {
        accent-color: #FF6B35;
        width: 18px;
        height: 18px;
    }

    /* Info panel */
    .info-panel {
        background: rgba(16,185,129,0.08);
        border: 1px solid rgba(16,185,129,0.2);
        border-radius: 10px;
        padding: 16px;
        margin-top: 16px;
    }
    .info-panel.manual {
        background: rgba(6,182,212,0.08);
        border-color: rgba(6,182,212,0.2);
    }
    .info-panel .step {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 6px;
        font-size: 0.85rem;
        color: #94A3B8;
    }
    .info-panel .step-num {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        color: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 700;
        flex-shrink: 0;
    }

    /* Terms checkbox */
    .terms-check {
        background: #0F172A;
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 10px;
        padding: 14px 16px;
    }
    .terms-check .form-check-input {
        accent-color: #FF6B35;
    }

    /* CTA button */
    .checkout-cta {
        background: linear-gradient(135deg, #FF6B35 0%, #e55a2b 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 1.1rem;
        font-weight: 700;
        width: 100%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    .checkout-cta:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(255,107,53,0.3); }
    .checkout-cta:disabled { opacity: 0.6; transform: none; box-shadow: none; }

    /* Security badges */
    .security-badges {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-top: 16px;
    }
    .security-badges span {
        color: #475569;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* User info row */
    .user-info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .user-info-row:last-child { border-bottom: none; }
    .user-info-label { color: #64748B; font-size: 0.85rem; }
    .user-info-value { color: #f1f5f9; font-weight: 500; font-size: 0.85rem; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-8">

            <!-- Header -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h5 class="mb-0" style="font-weight: 700;">Finalizar Compra</h5>
                <a href="{{ url_for('shop.packages') }}" style="color: #64748B; text-decoration: none; font-size: 0.85rem;">
                    <i class="fas fa-arrow-left me-1"></i>Voltar
                </a>
            </div>

            <!-- Package Preview -->
            <div class="checkout-package">
                <div class="pkg-name">{{ package.name }}</div>
                <div class="pkg-credits">{{ package.credits }}</div>
                <div style="color: #64748B; font-size: 0.8rem; margin-bottom: 8px;">creditos</div>
                <div class="pkg-price">R$ {{ "%.2f"|format(package.price) }}</div>
                {% if package.installments > 1 %}
                <div style="color: #94A3B8; font-size: 0.85rem; margin-top: 4px;">
                    ou {{ package.installments }}x de R$ {{ "%.2f"|format(package.installment_price) }}
                </div>
                {% endif %}
                <div style="color: #64748B; font-size: 0.75rem; margin-top: 8px;">
                    <i class="far fa-clock me-1"></i>Valido por {{ package.validity_days }} dias
                </div>
            </div>

            <!-- User Data -->
            <div class="card mb-3">
                <div class="card-body">
                    <div style="font-size: 0.75rem; color: #64748B; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">
                        <i class="fas fa-user me-1"></i>Seus Dados
                    </div>
                    <div class="user-info-row">
                        <span class="user-info-label">Nome</span>
                        <span class="user-info-value">{{ current_user.name }}</span>
                    </div>
                    <div class="user-info-row">
                        <span class="user-info-label">E-mail</span>
                        <span class="user-info-value">{{ current_user.email }}</span>
                    </div>
                    <div class="user-info-row">
                        <span class="user-info-label">Telefone</span>
                        <span class="user-info-value">{{ current_user.phone }}</span>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="card mb-3">
                <div class="card-body">
                    <div style="font-size: 0.75rem; color: #64748B; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">
                        <i class="fas fa-credit-card me-1"></i>Forma de Pagamento
                    </div>

                    <!-- NuPay PIX -->
                    <div class="method-card {% if current_user.cpf %}selected{% else %}disabled{% endif %}" id="methodNupay" onclick="selectMethod('nupay_pix')">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="payment_method" value="nupay_pix" class="method-radio"
                                   id="nupay_pix" {% if current_user.cpf %}checked{% else %}disabled{% endif %}>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2">
                                    <strong style="font-size: 0.9rem;">PIX Instantaneo</strong>
                                    <span style="background: #10B981; color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; font-weight: 600;">RECOMENDADO</span>
                                </div>
                                <div style="color: #64748B; font-size: 0.8rem; margin-top: 2px;">Confirmacao automatica em segundos</div>
                            </div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/120px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png"
                                 alt="PIX" style="height: 20px; filter: brightness(0) invert(0.8);">
                        </div>
                        {% if not current_user.cpf %}
                        <div style="margin-top: 10px; background: rgba(255,107,53,0.1); border-radius: 8px; padding: 8px 12px; font-size: 0.8rem; color: #FF6B35;">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <a href="{{ url_for('student.profile_edit') }}" style="color: #FF6B35; font-weight: 600;">Cadastre seu CPF</a> para usar esta opcao
                        </div>
                        {% endif %}
                    </div>

                    <!-- PIX Manual -->
                    <div class="method-card {% if not current_user.cpf %}selected{% endif %}" id="methodManual" onclick="selectMethod('pix_manual')">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="payment_method" value="pix_manual" class="method-radio"
                                   id="pix_manual" {% if not current_user.cpf %}checked{% endif %}>
                            <div class="flex-grow-1">
                                <strong style="font-size: 0.9rem;">PIX Manual</strong>
                                <div style="color: #64748B; font-size: 0.8rem; margin-top: 2px;">Envie comprovante para aprovacao (ate 24h)</div>
                            </div>
                            <i class="fas fa-qrcode" style="color: #64748B; font-size: 1.3rem;"></i>
                        </div>
                    </div>

                    <!-- Info Panels -->
                    <div id="nupay-info" class="info-panel {% if not current_user.cpf %}d-none{% endif %}">
                        <div class="step"><div class="step-num">1</div><div>Escaneie o QR Code ou copie o codigo PIX</div></div>
                        <div class="step"><div class="step-num">2</div><div>Pague pelo app do seu banco</div></div>
                        <div class="step"><div class="step-num">3</div><div>Confirmacao automatica em segundos!</div></div>
                        <div class="step"><div class="step-num">4</div><div style="color: #10B981;">Creditos liberados imediatamente</div></div>
                    </div>

                    <div id="manual-info" class="info-panel manual {% if current_user.cpf %}d-none{% endif %}">
                        <div class="step"><div class="step-num">1</div><div>Apos confirmar, acesse "Minhas Assinaturas"</div></div>
                        <div class="step"><div class="step-num">2</div><div>Faca o PIX e envie o comprovante</div></div>
                        <div class="step"><div class="step-num">3</div><div>Aguarde a aprovacao (ate 24h)</div></div>
                        <div class="step"><div class="step-num">4</div><div>Seus creditos serao liberados apos aprovacao</div></div>
                    </div>

                    {% if package.installments > 1 %}
                    <div style="margin-top: 12px; background: rgba(255,107,53,0.08); border: 1px solid rgba(255,107,53,0.2); border-radius: 8px; padding: 12px; font-size: 0.8rem; color: #FF6B35;">
                        <i class="fas fa-calendar-alt me-1"></i>
                        <strong>Parcelamento:</strong> {{ package.installments }} parcelas de R$ {{ "%.2f"|format(package.installment_price) }}.
                        Primeira vence hoje, proximas a cada 30 dias.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Terms -->
            <div class="terms-check mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="terms">
                    <label class="form-check-label" for="terms" style="font-size: 0.85rem; color: #94A3B8;">
                        Li e concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal" style="color: #FF6B35;">termos e condicoes</a>
                    </label>
                </div>
            </div>

            <!-- CTA -->
            <form method="POST" id="checkoutForm">
                <button type="submit" class="checkout-cta" id="confirmBtn" disabled>
                    <i class="fas fa-lock"></i>
                    Confirmar Compra â€” R$ {{ "%.2f"|format(package.price) }}
                </button>
            </form>

            <!-- Security Badges -->
            <div class="security-badges">
                <span><i class="fas fa-lock me-1"></i>Seguro</span>
                <span><i class="fas fa-shield-alt me-1"></i>Criptografado</span>
                <span><i class="fas fa-undo me-1"></i>Cancelavel</span>
            </div>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom-color: rgba(255,255,255,0.06);">
                <h5 class="modal-title">Termos e Condicoes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="color: #94A3B8;">
                <h6 style="color: #f1f5f9;">1. Creditos</h6>
                <p>Os creditos adquiridos tem validade de {{ package.validity_days }} dias a partir da data da compra.</p>
                <h6 style="color: #f1f5f9;">2. Pagamento</h6>
                <p>O pagamento deve ser realizado via PIX. Para PIX Instantaneo (NuPay), a liberacao e automatica. Para PIX Manual, a aprovacao ocorre em ate 24 horas uteis.</p>
                <h6 style="color: #f1f5f9;">3. Cancelamento de Aulas</h6>
                <p>Aulas podem ser canceladas ate 2 horas antes do horario agendado, com estorno do credito.</p>
                <h6 style="color: #f1f5f9;">4. Inadimplencia</h6>
                <p>Com 15 dias de atraso no pagamento, a conta sera bloqueada. Com 90 dias, os creditos serao cancelados.</p>
                <h6 style="color: #f1f5f9;">5. Reembolso</h6>
                <p>Nao ha reembolso de creditos nao utilizados apos o vencimento.</p>
            </div>
            <div class="modal-footer" style="border-top-color: rgba(255,255,255,0.06);">
                <button type="button" class="btn" style="background: #FF6B35; color: white;" data-bs-dismiss="modal">Entendi</button>
            </div>
        </div>
    </div>
</div>

<!-- CPF Modal -->
{% if not current_user.cpf %}
<div class="modal fade" id="cpfModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom-color: rgba(255,255,255,0.06);">
                <h5 class="modal-title"><i class="fas fa-id-card me-2" style="color: #FF6B35;"></i>Informe seu CPF</h5>
            </div>
            <div class="modal-body">
                <p style="color: #94A3B8; font-size: 0.9rem;">Para gerar o PIX NuPay Instantaneo, precisamos do seu CPF.</p>
                <form id="cpfForm">
                    <div class="mb-3">
                        <label class="form-label" style="color: #64748B; font-size: 0.85rem;">CPF *</label>
                        <input type="text" id="modal-cpf" class="form-control" placeholder="000.000.000-00" required maxlength="14">
                        <div id="cpf-error" class="small mt-1 d-none" style="color: #F43F5E;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top-color: rgba(255,255,255,0.06);">
                <button type="button" class="btn btn-sm" style="color: #64748B;" onclick="window.history.back()">Voltar</button>
                <button type="submit" form="cpfForm" id="btnSaveCpf" class="btn btn-sm" style="background: #FF6B35; color: white;">Salvar e Continuar</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    document.body.classList.add('dark-checkout');

    function selectMethod(method) {
        if (method === 'nupay_pix' && !document.getElementById('nupay_pix').disabled) {
            document.getElementById('nupay_pix').checked = true;
            document.getElementById('methodNupay').classList.add('selected');
            document.getElementById('methodManual').classList.remove('selected');
            document.getElementById('nupay-info').classList.remove('d-none');
            document.getElementById('manual-info').classList.add('d-none');
        } else if (method === 'pix_manual') {
            document.getElementById('pix_manual').checked = true;
            document.getElementById('methodManual').classList.add('selected');
            document.getElementById('methodNupay').classList.remove('selected');
            document.getElementById('nupay-info').classList.add('d-none');
            document.getElementById('manual-info').classList.remove('d-none');
        }
    }

    // Terms checkbox enables CTA
    document.getElementById('terms').addEventListener('change', function() {
        document.getElementById('confirmBtn').disabled = !this.checked;
    });

    {% if not current_user.cpf %}
    var cpfModal = new bootstrap.Modal(document.getElementById('cpfModal'));

    document.getElementById('methodNupay').addEventListener('click', function(e) {
        if (document.getElementById('nupay_pix').disabled) {
            e.stopPropagation();
            cpfModal.show();
        }
    });

    var modalCpfInput = document.getElementById('modal-cpf');
    modalCpfInput.addEventListener('input', function(e) {
        var value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
        else if (value.length > 3) value = value.replace(/(\d{3})(\d{1,3})/, "$1.$2");
        e.target.value = value;
    });

    document.getElementById('cpfForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var cpfValue = modalCpfInput.value;
        var btn = document.getElementById('btnSaveCpf');
        var errorEl = document.getElementById('cpf-error');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
        errorEl.classList.add('d-none');

        fetch("{{ url_for('student.update_cpf') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cpf: cpfValue })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                location.reload();
            } else {
                errorEl.textContent = data.error || 'Erro ao validar CPF.';
                errorEl.classList.remove('d-none');
                btn.disabled = false;
                btn.textContent = 'Salvar e Continuar';
            }
        })
        .catch(function() {
            errorEl.textContent = 'Erro de conexao.';
            errorEl.classList.remove('d-none');
            btn.disabled = false;
            btn.textContent = 'Salvar e Continuar';
        });
    });
    {% endif %}

    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        if (!document.getElementById('terms').checked) {
            e.preventDefault();
            return;
        }

        var method = document.querySelector('input[name="payment_method"]:checked');
        if (!method) {
            e.preventDefault();
            return;
        }

        var hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'payment_method';
        hiddenInput.value = method.value;
        this.appendChild(hiddenInput);

        var btn = document.getElementById('confirmBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    });
</script>
{% endblock %}
