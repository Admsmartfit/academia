{% extends "base.html" %}

{% block title %}Minha Area - Academia{% endblock %}

{% block extra_css %}
<style>
    /* Dark Mode Override for Student Dashboard */
    body.dark-student {
        background-color: #0F172A !important;
        color: #f1f5f9;
    }
    body.dark-student .navbar,
    body.dark-student nav {
        background-color: #1E293B !important;
    }
    body.dark-student .card {
        background-color: #1E293B;
        border: 1px solid rgba(255,255,255,0.06);
        color: #f1f5f9;
    }
    body.dark-student .card-header {
        background-color: rgba(255,255,255,0.03);
        border-bottom: 1px solid rgba(255,255,255,0.06);
        color: #f1f5f9;
    }
    body.dark-student .list-group-item {
        background-color: transparent;
        border-color: rgba(255,255,255,0.06);
        color: #f1f5f9;
    }
    body.dark-student .text-muted {
        color: #94a3b8 !important;
    }
    body.dark-student .alert-info {
        background-color: rgba(6,182,212,0.1);
        border-color: rgba(6,182,212,0.2);
        color: #67e8f9;
    }
    body.dark-student .alert-warning {
        background-color: rgba(251,191,36,0.1);
        border-color: rgba(251,191,36,0.2);
        color: #fbbf24;
    }
    body.dark-student .alert-success {
        background-color: rgba(16,185,129,0.1);
        border-color: rgba(16,185,129,0.2);
        color: #6ee7b7;
    }
    body.dark-student .alert-primary {
        background-color: rgba(255,107,53,0.1) !important;
        border-color: rgba(255,107,53,0.2);
        color: #f1f5f9 !important;
    }

    /* Hero Card - Treino do Dia */
    .hero-training-card {
        background: linear-gradient(135deg, #1E293B, rgba(255,107,53,0.12));
        border: 1px solid rgba(255,107,53,0.3);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }
    .hero-training-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255,107,53,0.08) 0%, transparent 70%);
        border-radius: 50%;
    }
    .hero-training-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: #FF6B35;
        font-weight: 700;
        margin-bottom: 8px;
    }
    .hero-training-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 4px;
    }
    .hero-training-meta {
        color: #94a3b8;
        font-size: 0.9rem;
    }
    .hero-training-meta i {
        color: #06B6D4;
        margin-right: 4px;
    }

    /* Stats Row */
    .stat-card {
        background-color: #1E293B;
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-value {
        font-size: 2.2rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 4px;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .stat-accent { color: #FF6B35; }
    .stat-cyan { color: #06B6D4; }
    .stat-violet { color: #8B5CF6; }

    /* Health Score Ring */
    .health-ring-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto;
    }
    .health-ring-svg {
        transform: rotate(-90deg);
    }
    .health-ring-track {
        fill: none;
        stroke: rgba(255,255,255,0.06);
        stroke-width: 8;
    }
    .health-ring-fill {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1.5s ease, stroke 0.5s ease;
    }
    .health-ring-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    .health-ring-number {
        font-size: 1.8rem;
        font-weight: 800;
        line-height: 1;
    }
    .health-ring-label {
        font-size: 0.65rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Heartbeat animation */
    @keyframes heartbeat {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        15% { transform: translate(-50%, -50%) scale(1.05); }
        30% { transform: translate(-50%, -50%) scale(1); }
        45% { transform: translate(-50%, -50%) scale(1.03); }
    }
    .health-pulse {
        animation: heartbeat 2s ease-in-out infinite;
    }

    /* XP Header Bar */
    .xp-header-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(90deg, rgba(139,92,246,0.1), transparent);
        border-radius: 10px;
        padding: 10px 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(139,92,246,0.15);
    }
    .xp-level-badge {
        background: linear-gradient(135deg, #8B5CF6, #a78bfa);
        color: white;
        font-weight: 800;
        font-size: 0.8rem;
        padding: 4px 12px;
        border-radius: 20px;
        white-space: nowrap;
    }
    .xp-progress-track {
        flex: 1;
        height: 6px;
        background: rgba(255,255,255,0.08);
        border-radius: 3px;
        overflow: hidden;
    }
    .xp-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #8B5CF6, #a78bfa);
        border-radius: 3px;
        transition: width 1s ease;
    }
    .xp-text {
        font-size: 0.8rem;
        color: #a78bfa;
        white-space: nowrap;
    }

    /* Streak badge */
    .streak-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(255,107,53,0.05));
        border: 1px solid rgba(255,107,53,0.2);
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #FF6B35;
    }

    /* Booking list item */
    .booking-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        border-radius: 10px;
        background: rgba(255,255,255,0.02);
        margin-bottom: 8px;
        transition: background 0.2s;
    }
    .booking-item:hover {
        background: rgba(255,255,255,0.04);
    }
    .booking-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .booking-date {
        font-size: 0.8rem;
        color: #64748b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- XP / Level Header Bar -->
    <div class="xp-header-bar">
        <span class="xp-level-badge">Nv. {{ current_user.level }}</span>
        <div class="xp-progress-track">
            <div class="xp-progress-fill" style="width: {{ (current_user.xp % 100)|int }}%;"></div>
        </div>
        <span class="xp-text">{{ current_user.xp }} XP</span>
        {% if streak and streak > 1 %}
        <span class="streak-badge"><i class="fas fa-fire"></i> {{ streak }} dias</span>
        {% endif %}
    </div>

    <!-- Treino do Dia (Hero Card) -->
    {% if next_booking %}
    <div class="hero-training-card">
        <div class="hero-training-label">Treino do Dia</div>
        <div class="hero-training-title">{{ next_booking.schedule.modality.name }}</div>
        <div class="hero-training-meta">
            <span><i class="fas fa-clock"></i> {{ next_booking.schedule.start_time.strftime('%H:%M') }} - {{ next_booking.schedule.end_time.strftime('%H:%M') }}</span>
            <span class="ms-3"><i class="fas fa-user"></i> {{ next_booking.schedule.instructor.name.split()[0] if next_booking.schedule.instructor else 'TBD' }}</span>
            <span class="ms-3"><i class="fas fa-calendar"></i> {{ next_booking.date.strftime('%d/%m') }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Stats Row -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-value stat-accent">{{ current_user.total_credits }}</div>
                <div class="stat-label">Creditos</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-value stat-cyan">{{ total_classes }}</div>
                <div class="stat-label">Aulas</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <div class="stat-value stat-violet">#{{ user_rank }}</div>
                <div class="stat-label">Ranking</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-card">
                <!-- Health Score Ring -->
                {% set score = health_score.total_score|int if health_score else 0 %}
                {% if score >= 70 %}
                    {% set ring_color = '#10B981' %}
                {% elif score >= 40 %}
                    {% set ring_color = '#FBBF24' %}
                {% else %}
                    {% set ring_color = '#F43F5E' %}
                {% endif %}
                <div class="health-ring-container">
                    <svg class="health-ring-svg" width="120" height="120" viewBox="0 0 120 120">
                        <circle class="health-ring-track" cx="60" cy="60" r="50"></circle>
                        <circle class="health-ring-fill" cx="60" cy="60" r="50"
                            stroke="{{ ring_color }}"
                            stroke-dasharray="314.16"
                            stroke-dashoffset="{{ 314.16 - (314.16 * score / 100) }}">
                        </circle>
                    </svg>
                    <div class="health-ring-value health-pulse">
                        <div class="health-ring-number" style="color: {{ ring_color }};">{{ score }}</div>
                        <div class="health-ring-label">Health</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    {% if pending_payments %}
    <div class="alert alert-warning mb-3">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Pagamentos pendentes!</strong> Voce tem {{ pending_payments|length }} parcela(s) aguardando.
        <a href="{{ url_for('student.my_subscriptions') }}" class="alert-link">Ver detalhes</a>
    </div>
    {% endif %}

    {% if screening_status is none %}
    <div class="alert alert-primary mb-3 border-0">
        <div class="d-flex align-items-center">
            <i class="fas fa-heartbeat fa-2x me-3"></i>
            <div>
                <h6 class="mb-0 fw-bold">Preencha o questionario de saude</h6>
                <small>Leva apenas 1 minuto e e obrigatorio para treinar.</small>
            </div>
            <a href="{{ url_for('health.fill_parq') }}" class="btn btn-sm btn-light ms-auto fw-bold rounded-pill">PREENCHER</a>
        </div>
    </div>
    {% elif screening_status.value == 'expirado' %}
    <div class="alert alert-warning mb-3 border-0">
        <div class="d-flex align-items-center">
            <i class="fas fa-clock fa-2x me-3"></i>
            <div>
                <h6 class="mb-0 fw-bold">PAR-Q expirado</h6>
                <small>Renove seu questionario de saude para continuar treinando.</small>
            </div>
            <a href="{{ url_for('health.fill_parq') }}" class="btn btn-sm btn-warning ms-auto fw-bold rounded-pill text-dark">RENOVAR</a>
        </div>
    </div>
    {% elif screening_status.value == 'pendente_medico' %}
    {% set latest_screening = current_user.health_screenings|selectattr('screening_type.value', 'equalto', 'parq')|sort(attribute='created_at', reverse=True)|first %}
    {% if not latest_screening.medical_certificate_url %}
    <div class="alert alert-info mb-3 border-0">
        <div class="d-flex align-items-center">
            <i class="fas fa-stethoscope fa-2x me-3"></i>
            <div>
                <h6 class="mb-0 fw-bold">Aguardando atestado medico</h6>
                <small>Envie sua liberacao medica para treinar.</small>
            </div>
            <a href="{{ url_for('health.parq_pending') }}" class="btn btn-sm btn-info ms-auto fw-bold rounded-pill text-white">ENVIAR</a>
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if expiring_credits and expiring_credits > 0 %}
    <div class="alert alert-info mb-3">
        <i class="fas fa-clock me-2"></i>
        <strong>{{ expiring_credits }}</strong> creditos expirando em 7 dias.
        <a href="{{ url_for('student.xp_credits') }}" class="alert-link">Ver detalhes</a>
    </div>
    {% endif %}

    {% if xp_available and xp_available >= 500 %}
    <div class="alert alert-success mb-3">
        <i class="fas fa-gift me-2"></i>
        <strong>{{ "{:,}".format(xp_available) }}</strong> XP disponiveis para converter em creditos.
        <a href="{{ url_for('student.xp_credits') }}" class="alert-link">Converter agora</a>
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- Proximas Aulas -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-calendar me-2" style="color: #06B6D4;"></i>Proximas Aulas</span>
                    <a href="{{ url_for('student.schedule') }}" class="btn btn-sm" style="background: #FF6B35; color: white;">Agendar</a>
                </div>
                <div class="card-body">
                    {% if upcoming_bookings %}
                    {% for booking in upcoming_bookings %}
                    <div class="booking-item">
                        <div class="booking-dot" style="background-color: {{ booking.schedule.modality.color if booking.schedule.modality else '#FF6B35' }};"></div>
                        <div style="flex: 1;">
                            <strong>{{ booking.schedule.modality.name }}</strong>
                            <div class="booking-date">
                                {{ booking.date.strftime('%d/%m') }} - {{ booking.schedule.start_time.strftime('%H:%M') }}
                                | {{ booking.schedule.instructor.name.split()[0] if booking.schedule.instructor else '' }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x mb-3" style="color: #334155;"></i>
                        <p class="text-muted mb-0">Nenhuma aula agendada</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Assinaturas Ativas -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-ticket-alt me-2" style="color: #8B5CF6;"></i>Minhas Assinaturas</span>
                    <a href="{{ url_for('student.my_subscriptions') }}" class="btn btn-outline-light btn-sm">Ver todas</a>
                </div>
                <div class="card-body">
                    {% if active_subscriptions %}
                    {% for sub in active_subscriptions %}
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 1px solid rgba(255,255,255,0.06);">
                        <div>
                            <strong>{{ sub.package.name }}</strong>
                            <br>
                            <small style="color: #64748b;">{{ sub.credits_remaining }} creditos restantes</small>
                        </div>
                        <div class="text-end">
                            {% if sub.days_until_expiry > 7 %}
                            <span class="badge" style="background: rgba(16,185,129,0.15); color: #10B981;">{{ sub.days_until_expiry }} dias</span>
                            {% elif sub.days_until_expiry > 0 %}
                            <span class="badge" style="background: rgba(251,191,36,0.15); color: #FBBF24;">{{ sub.days_until_expiry }} dias</span>
                            {% else %}
                            <span class="badge" style="background: rgba(244,63,94,0.15); color: #F43F5E;">Expirada</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-box-open fa-3x mb-3" style="color: #334155;"></i>
                        <p class="text-muted mb-3">Nenhuma assinatura ativa</p>
                        <a href="{{ url_for('shop.packages') }}" class="btn btn-sm" style="background: #FF6B35; color: white;">Adquirir Pacote</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Reconhecimento Facial + Conquistas -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header" style="background: rgba(255,107,53,0.08);">
                    <h6 class="mb-0">
                        <i class="fas fa-user-shield me-2" style="color: #FF6B35;"></i>Reconhecimento Facial
                    </h6>
                </div>
                <div class="card-body">
                    {% if current_user.face_encoding %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Face cadastrada em {{ current_user.face_registered_at.strftime('%d/%m/%Y %H:%M') if current_user.face_registered_at else 'data desconhecida' }}
                    </div>
                    <div class="text-center mb-3">
                        <div class="rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px; background: rgba(16,185,129,0.1); border: 2px solid rgba(16,185,129,0.3);">
                            <i class="fas fa-user-check fa-3x" style="color: #10B981;"></i>
                        </div>
                    </div>
                    <button class="btn btn-outline-warning w-100 btn-sm" onclick="removeFace()">
                        <i class="fas fa-trash me-2"></i>Remover Face
                    </button>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Cadastre sua face para check-in automatico!
                    </div>

                    <div class="text-center mb-3">
                        <video id="webcam" width="320" height="240" autoplay playsinline style="display:none;" class="rounded"></video>
                        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
                        <img id="capturedImage" width="320" height="240" style="display:none;" class="rounded">
                    </div>

                    <div class="btn-group d-flex mb-3" role="group">
                        <input type="radio" class="btn-check" name="captureMethod" id="methodUpload" value="upload" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="methodUpload">
                            <i class="fas fa-upload me-1"></i>Upload
                        </label>
                        <input type="radio" class="btn-check" name="captureMethod" id="methodWebcam" value="webcam">
                        <label class="btn btn-outline-secondary btn-sm" for="methodWebcam">
                            <i class="fas fa-camera me-1"></i>Webcam
                        </label>
                    </div>

                    <div id="uploadSection">
                        <input type="file" id="fileInput" accept="image/*" class="form-control form-control-sm" style="background: #0F172A; border-color: rgba(255,255,255,0.1); color: #f1f5f9;">
                        <small style="color: #64748b;">JPG, PNG | Max 5MB | Min 320x240px</small>
                    </div>

                    <div id="webcamSection" style="display:none;">
                        <button class="btn btn-sm w-100 mb-2" style="background: #FF6B35; color: white;" onclick="startWebcam()">
                            <i class="fas fa-video me-2"></i>Iniciar Camera
                        </button>
                        <button class="btn btn-sm btn-outline-success w-100" onclick="capturePhoto()" id="captureBtn" disabled>
                            <i class="fas fa-camera me-2"></i>Capturar
                        </button>
                    </div>

                    <div class="form-check mt-3 mb-3">
                        <input type="checkbox" class="form-check-input" id="consentCheck">
                        <label class="form-check-label" for="consentCheck" style="font-size: 0.85em; color: #94a3b8;">
                            Li e concordo com o Termo de Consentimento de Dados Biometricos (LGPD)
                        </label>
                    </div>

                    <button class="btn w-100" style="background: #FF6B35; color: white;" onclick="enrollFace()" id="enrollBtn" disabled>
                        <i class="fas fa-check me-2"></i>Cadastrar Face
                    </button>
                    {% endif %}

                    <div id="faceAlerts" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Conquistas -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-trophy me-2" style="color: #FBBF24;"></i>Minhas Conquistas</h6>
                </div>
                <div class="card-body">
                    {% if current_user.unlocked_achievements %}
                    <div class="d-flex flex-wrap gap-3">
                        {% for ua in current_user.unlocked_achievements %}
                        <div class="text-center" style="width: 80px;" title="{{ ua.achievement.description }}">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2 achievement-circle"
                                data-color="{{ ua.achievement.color|default('#334155', true) }}"
                                style="width: 60px; height: 60px;">
                                {% if ua.achievement.icon_url and ua.achievement.icon_url.startswith('/') %}
                                <img src="{{ ua.achievement.icon_url }}" style="width: 40px;">
                                {% elif ua.achievement.icon_url %}
                                <span style="font-size: 28px;">{{ ua.achievement.icon_url }}</span>
                                {% else %}
                                <i class="fas fa-medal fa-2x text-white"></i>
                                {% endif %}
                            </div>
                            <small class="d-block" style="color: #94a3b8;">{{ ua.achievement.name }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-medal fa-3x mb-2" style="color: #334155;"></i>
                        <p class="text-muted mb-0">Complete aulas para desbloquear conquistas!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Push Notification Opt-In -->
    <div class="col-12">
        <div id="push-optin" style="display:none;">
            <div class="card" style="border: 1px solid rgba(255,107,53,0.3); background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);">
                <div class="card-body d-flex align-items-center gap-3 py-3">
                    <div style="width:44px;height:44px;background:#FF6B35;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <i class="fas fa-bell" style="color:white;font-size:18px;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <strong style="color:#f1f5f9;">Ativar Notificacoes</strong>
                        <p class="mb-0" style="color:#94A3B8;font-size:0.85rem;">Receba lembretes de aulas e conquistas no celular</p>
                    </div>
                    <button class="push-enable-btn btn btn-sm" style="background:#FF6B35;color:white;white-space:nowrap;">
                        <i class="fas fa-bell me-1"></i>Ativar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<script>
    // Apply dark mode
    document.body.classList.add('dark-student');

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.achievement-circle').forEach(function (el) {
            el.style.backgroundColor = el.dataset.color;
        });
        // Initialize push notification opt-in
        if (typeof window.initPushOptIn === 'function') {
            window.initPushOptIn();
        }
    });
</script>
<script src="{{ url_for('static', filename='js/face-enrollment.js') }}"></script>
{% endblock %}
