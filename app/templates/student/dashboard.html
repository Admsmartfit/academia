{% extends "base.html" %}

{% block title %}Minha Area - Academia{% endblock %}

{% block content %}
<div class="container py-4">
    <h3 class="mb-4">Bem-vindo(a), {{ current_user.name }}!</h3>

    <div class="row g-4 mb-4">
        <!-- Creditos Disponiveis -->
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-3">{{ current_user.total_credits }}</h1>
                    <p class="mb-0">Creditos Disponiveis</p>
                </div>
                <div class="card-footer bg-transparent border-0 text-center">
                    <a href="{{ url_for('shop.packages') }}" class="btn btn-light btn-sm">Comprar mais</a>
                </div>
            </div>
        </div>

        <!-- XP e Nivel -->
        <div class="col-md-4">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-3">{{ current_user.xp }}</h1>
                    <p class="mb-0">XP (Nivel {{ current_user.level }})</p>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-light xp-progress-bar"
                            data-width="{{ (current_user.xp % 100)|int }}" style="width: 0%;"></div>
                    </div>
                    <small>{{ 100 - (current_user.xp % 100) }} XP para o proximo nivel</small>
                </div>
            </div>
        </div>

        <!-- Aulas Completadas -->
        <div class="col-md-4">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-3">{{ current_user.completed_bookings_count }}</h1>
                    <p class="mb-0">Aulas Completadas</p>
                </div>
            </div>
        </div>
    </div>

    {% if pending_payments %}
    <div class="alert alert-warning mb-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Pagamentos pendentes!</strong> Voce tem {{ pending_payments|length }} parcela(s) aguardando pagamento.
        <a href="{{ url_for('student.my_subscriptions') }}" class="alert-link">Ver detalhes</a>
    </div>
    {% endif %}

    <!-- Alerta de Triagem de Sa√∫de (PAR-Q) -->
    {% if screening_status is none %}
    <div class="alert alert-primary mb-4 shadow-sm border-0 bg-primary text-white">
        <div class="d-flex align-items-center">
            <i class="fas fa-heartbeat fa-2x me-3"></i>
            <div>
                <h5 class="mb-1 fw-bold">Seguran√ßa em Primeiro Lugar! üòä</h5>
                <p class="mb-0">Para come√ßar suas atividades, preencha o question√°rio de sa√∫de. Leva apenas 1 minuto!
                </p>
            </div>
            <a href="{{ url_for('health.fill_parq') }}"
                class="btn btn-light ms-auto fw-bold px-4 rounded-pill">PREENCHER AGORA</a>
        </div>
    </div>
    {% elif screening_status.value == 'expirado' %}
    <div class="alert alert-warning mb-4 shadow-sm border-0">
        <div class="d-flex align-items-center">
            <i class="fas fa-clock fa-2x me-3 text-warning"></i>
            <div>
                <h5 class="mb-1 fw-bold">Hora de renovar seu PAR-Q! ‚è∞</h5>
                <p class="mb-0 text-muted">Seu question√°rio de sa√∫de expirou. Para sua seguran√ßa, precisamos que voc√™
                    renove.</p>
            </div>
            <a href="{{ url_for('health.fill_parq') }}"
                class="btn btn-warning ms-auto fw-bold px-4 rounded-pill text-dark">RENOVAR AGORA</a>
        </div>
    </div>
    {% elif screening_status.value == 'pendente_medico' %}
    {% set latest_screening = current_user.health_screenings|selectattr('screening_type.value', 'equalto',
    'parq')|sort(attribute='created_at', reverse=True)|first %}
    {% if not latest_screening.medical_certificate_url %}
    <div class="alert alert-info mb-4 shadow-sm border-0 border-start border-4 border-info">
        <div class="d-flex align-items-center">
            <i class="fas fa-stethoscope fa-2x me-3 text-info"></i>
            <div>
                <h5 class="mb-1 fw-bold">Aguardando seu atestado m√©dico ü©∫</h5>
                <p class="mb-0 text-muted">Precisamos de uma libera√ß√£o m√©dica para voc√™ treinar com seguran√ßa.</p>
            </div>
            <a href="{{ url_for('health.parq_pending') }}"
                class="btn btn-info ms-auto fw-bold px-4 rounded-pill text-white">ENVIAR AGORA</a>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Alerta de Creditos Expirando -->
    {% if expiring_credits and expiring_credits > 0 %}
    <div class="alert alert-info mb-4">
        <i class="fas fa-clock me-2"></i>
        <strong>Creditos expirando!</strong> Voce tem <strong>{{ expiring_credits }}</strong> creditos que vao expirar
        nos proximos 7 dias.
        <a href="{{ url_for('student.xp_credits') }}" class="alert-link">Ver detalhes</a>
    </div>
    {% endif %}

    <!-- Alerta de XP Disponivel para Conversao -->
    {% if xp_available and xp_available >= 500 %}
    <div class="alert alert-success mb-4">
        <i class="fas fa-gift me-2"></i>
        <strong>XP disponivel!</strong> Voce tem <strong>{{ "{:,}".format(xp_available) }}</strong> XP disponiveis para
        converter em creditos.
        <a href="{{ url_for('student.xp_credits') }}" class="alert-link">Converter agora</a>
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- Proximas Aulas -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-calendar me-2"></i>Proximas Aulas</span>
                    <a href="{{ url_for('student.schedule') }}" class="btn btn-primary btn-sm">Agendar</a>
                </div>
                <div class="card-body">
                    {% if upcoming_bookings %}
                    <ul class="list-group list-group-flush">
                        {% for booking in upcoming_bookings %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ booking.schedule.modality.name }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ booking.date.strftime('%d/%m') }} -
                                    {{ booking.schedule.start_time.strftime('%H:%M') }}
                                </small>
                            </div>
                            <span class="badge bg-primary">
                                {{ booking.schedule.instructor.name.split()[0] }}
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Nenhuma aula agendada</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Assinaturas Ativas -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-ticket-alt me-2"></i>Minhas Assinaturas</span>
                    <a href="{{ url_for('student.my_subscriptions') }}" class="btn btn-outline-primary btn-sm">Ver
                        todas</a>
                </div>
                <div class="card-body">
                    {% if active_subscriptions %}
                    {% for sub in active_subscriptions %}
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <div>
                            <strong>{{ sub.package.name }}</strong>
                            <br>
                            <small class="text-muted">
                                {{ sub.credits_remaining }} creditos restantes
                            </small>
                        </div>
                        <div class="text-end">
                            {% if sub.days_until_expiry > 7 %}
                            <span class="badge bg-success">{{ sub.days_until_expiry }} dias</span>
                            {% elif sub.days_until_expiry > 0 %}
                            <span class="badge bg-warning text-dark">{{ sub.days_until_expiry }} dias</span>
                            {% else %}
                            <span class="badge bg-danger">Expirada</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-3">Nenhuma assinatura ativa</p>
                        <a href="{{ url_for('shop.packages') }}" class="btn btn-primary">
                            Adquirir Pacote
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Reconhecimento Facial -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>Reconhecimento Facial
                    </h5>
                </div>
                <div class="card-body">
                    {% if current_user.face_encoding %}
                    <!-- Estado: Face ja cadastrada -->
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Face cadastrada em {{ current_user.face_registered_at.strftime('%d/%m/%Y %H:%M') if current_user.face_registered_at else 'data desconhecida' }}
                    </div>
                    <div class="text-center mb-3">
                        <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 150px; height: 150px;">
                            <i class="fas fa-user-check fa-4x text-success"></i>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100" onclick="removeFace()">
                        <i class="fas fa-trash me-2"></i>Remover Face
                    </button>
                    {% else %}
                    <!-- Estado: Face nao cadastrada -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Cadastre sua face para check-in automatico!
                    </div>

                    <div class="text-center mb-3">
                        <video id="webcam" width="320" height="240" autoplay playsinline style="display:none;" class="img-thumbnail"></video>
                        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
                        <img id="capturedImage" width="320" height="240" style="display:none;" class="img-thumbnail">
                    </div>

                    <!-- Opcoes de captura -->
                    <div class="btn-group d-flex mb-3" role="group">
                        <input type="radio" class="btn-check" name="captureMethod" id="methodUpload" value="upload" checked>
                        <label class="btn btn-outline-primary" for="methodUpload">
                            <i class="fas fa-upload me-1"></i>Upload
                        </label>
                        <input type="radio" class="btn-check" name="captureMethod" id="methodWebcam" value="webcam">
                        <label class="btn btn-outline-primary" for="methodWebcam">
                            <i class="fas fa-camera me-1"></i>Webcam
                        </label>
                    </div>

                    <!-- Upload de arquivo -->
                    <div id="uploadSection">
                        <input type="file" id="fileInput" accept="image/*" class="form-control">
                        <small class="form-text text-muted">
                            Formatos: JPG, PNG | Tamanho max: 5MB | Min. 320x240px
                        </small>
                    </div>

                    <!-- Captura via webcam -->
                    <div id="webcamSection" style="display:none;">
                        <button class="btn btn-primary w-100 mb-2" onclick="startWebcam()">
                            <i class="fas fa-video me-2"></i>Iniciar Camera
                        </button>
                        <button class="btn btn-success w-100" onclick="capturePhoto()" id="captureBtn" disabled>
                            <i class="fas fa-camera me-2"></i>Capturar Foto
                        </button>
                    </div>

                    <!-- Termo de consentimento -->
                    <div class="form-check mt-3 mb-3">
                        <input type="checkbox" class="form-check-input" id="consentCheck">
                        <label class="form-check-label" for="consentCheck" style="font-size: 0.9em;">
                            Li e concordo com o Termo de Consentimento de Dados Biometricos (LGPD)
                        </label>
                    </div>

                    <!-- Botao de envio -->
                    <button class="btn btn-lg btn-primary w-100" onclick="enrollFace()" id="enrollBtn" disabled>
                        <i class="fas fa-check me-2"></i>Cadastrar Face
                    </button>
                    {% endif %}

                    <!-- Area de alertas -->
                    <div id="faceAlerts" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conquistas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-trophy me-2"></i>Minhas Conquistas
                </div>
                <div class="card-body">
                    {% if current_user.unlocked_achievements %}
                    <div class="d-flex flex-wrap gap-3">
                        {% for ua in current_user.unlocked_achievements %}
                        <div class="text-center" style="width: 80px;" title="{{ ua.achievement.description }}">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2 achievement-circle"
                                data-color="{{ ua.achievement.color|default('#ccc', true) }}"
                                style="width: 60px; height: 60px;">
                                {% if ua.achievement.icon_url and ua.achievement.icon_url.startswith('/') %}
                                <img src="{{ ua.achievement.icon_url }}" style="width: 40px;">
                                {% elif ua.achievement.icon_url %}
                                <span style="font-size: 28px;">{{ ua.achievement.icon_url }}</span>
                                {% else %}
                                <i class="fas fa-medal fa-2x text-white"></i>
                                {% endif %}
                            </div>
                            <small class="d-block">{{ ua.achievement.name }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-medal fa-3x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Complete aulas para desbloquear conquistas!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.achievement-circle').forEach(function (el) {
            el.style.backgroundColor = el.dataset.color;
        });
        document.querySelectorAll('.xp-progress-bar').forEach(function (el) {
            el.style.width = el.dataset.width + '%';
        });
    });
</script>
<script src="{{ url_for('static', filename='js/face-enrollment.js') }}"></script>
{% endblock %}