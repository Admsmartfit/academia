{% extends "base.html" %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 text-primary"><i class="fas fa-user-edit me-2"></i>Meu Perfil</h5>
                </div>
                <div class="card-body p-4">
                    {% if not current_user.cpf or not current_user.gender %}
                    <div class="alert alert-warning mb-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Por favor, complete seu cadastro para desbloquear agendamentos.
                    </div>
                    {% endif %}

                    <form method="POST">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Nome Completo</label>
                            <input type="text" name="name" class="form-control" value="{{ current_user.name }}"
                                required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Telefone
                                (WhatsApp)</label>
                            <input type="tel" name="phone" id="phone" class="form-control"
                                value="{{ current_user.phone }}" required>
                            <div class="form-text">Usado para lembretes de aula.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">CPF</label>
                            <input type="text" name="cpf" id="cpf" class="form-control"
                                value="{{ current_user.cpf or '' }}" required maxlength="14"
                                placeholder="000.000.000-00">
                            {% if not current_user.cpf %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle me-1"></i> Obrigatório para identificação e
                                pagamentos.
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Sexo Bilógico</label>
                            <div class="d-flex gap-3 p-3 border rounded bg-light">
                                <div class="form-check">
                                    <input type="radio" name="gender" value="female" class="form-check-input"
                                        id="genderFemale" {% if current_user.gender and
                                        current_user.gender.name=='FEMALE' %}checked{% endif %} required>
                                    <label class="form-check-label" for="genderFemale">
                                        <i class="fas fa-venus text-danger me-1"></i> Feminino
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" name="gender" value="male" class="form-check-input"
                                        id="genderMale" {% if current_user.gender and current_user.gender.name=='MALE'
                                        %}checked{% endif %} required>
                                    <label class="form-check-label" for="genderMale">
                                        <i class="fas fa-mars text-primary me-1"></i> Masculino
                                    </label>
                                </div>
                            </div>
                            <div class="form-text small">Necessário para modalidades com segregação de público (ex:
                                horários exclusivos).</div>
                            {% if not current_user.gender %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle me-1"></i> Seleção obrigatória.
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary py-2 fw-bold">
                                <i class="fas fa-save me-1"></i> SALVAR ALTERAÇÕES
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Convide um Amigo -->
        <div class="col-md-8 col-lg-6 mt-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 text-success"><i class="fas fa-user-plus me-2"></i>Convide um Amigo</h5>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-3">
                        Compartilhe seu codigo de indicacao e ganhe <strong class="text-success">100 XP</strong> por cada amigo que se cadastrar e ativar um plano!
                    </p>

                    {% if current_user.referral_code %}
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Seu codigo de indicacao</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="fas fa-ticket-alt"></i></span>
                            <input type="text" class="form-control fw-bold text-center" id="referralCode"
                                value="{{ current_user.referral_code }}" readonly
                                style="font-size: 1.1rem; letter-spacing: 2px;">
                            <button class="btn btn-outline-primary" type="button" id="copyCodeBtn"
                                onclick="copyReferralCode()">
                                <i class="fas fa-copy me-1"></i>Copiar
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Link de convite</label>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" id="referralLink"
                                value="{{ url_for('auth.register', ref=current_user.referral_code, _external=True) }}" readonly>
                            <button class="btn btn-success btn-sm" type="button" onclick="copyReferralLink()">
                                <i class="fas fa-link me-1"></i>Copiar link
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-success mb-0 py-2">
                        <small>
                            <i class="fas fa-gift me-1"></i>
                            Voce ganha <strong>100 XP</strong> por cada indicacao convertida (amigo ativa um plano).
                        </small>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Complete seu perfil para gerar seu codigo de indicacao.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // CPF Mask Logic (Simple)
        const cpfInput = document.getElementById('cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 9) value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                else if (value.length > 6) value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
                else if (value.length > 3) value = value.replace(/(\d{3})(\d{1,3})/, "$1.$2");
                e.target.value = value;
            });
        }
    });

    function copyReferralCode() {
        var input = document.getElementById('referralCode');
        navigator.clipboard.writeText(input.value).then(function () {
            var btn = document.getElementById('copyCodeBtn');
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
            btn.classList.replace('btn-outline-primary', 'btn-success');
            setTimeout(function () {
                btn.innerHTML = '<i class="fas fa-copy me-1"></i>Copiar';
                btn.classList.replace('btn-success', 'btn-outline-primary');
            }, 2000);
        });
    }

    function copyReferralLink() {
        var input = document.getElementById('referralLink');
        navigator.clipboard.writeText(input.value).then(function () {
            var btn = input.nextElementSibling;
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
            setTimeout(function () {
                btn.innerHTML = '<i class="fas fa-link me-1"></i>Copiar link';
            }, 2000);
        });
    }
</script>
{% endblock %}