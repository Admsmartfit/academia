{% extends "admin/base.html" %}

{% block page_title %}Gestao de Retencao{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="fas fa-heartbeat me-2 text-danger"></i>Gestao de Retencao</h4>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="calculateScores()" id="btnCalcScores">
            <i class="fas fa-calculator me-1"></i>Calcular Health Scores
        </button>
        <button class="btn btn-outline-success" onclick="runAutomations()" id="btnRunAuto">
            <i class="fas fa-robot me-1"></i>Executar Automacoes
        </button>
    </div>
</div>

<!-- KPIs -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="fs-2 fw-bold text-primary">{{ total_scored }}</div>
                <small class="text-muted">Alunos Avaliados</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="fs-2 fw-bold text-danger">{{ critical_count }}</div>
                <small class="text-muted">Criticos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="fs-2 fw-bold text-warning">{{ high_count }}</div>
                <small class="text-muted">Alto Risco</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="fs-2 fw-bold text-info">{{ avg_score }}</div>
                <small class="text-muted">Score Medio</small>
            </div>
        </div>
    </div>
</div>

<!-- Alunos em Risco -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-exclamation-triangle text-warning me-2"></i>Alunos Criticos e Alto Risco</span>
        <span class="badge bg-danger">{{ at_risk_students|length }} aluno(s)</span>
    </div>
    <div class="card-body p-0">
        {% if at_risk_students %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Aluno</th>
                        <th>Score</th>
                        <th>Risco</th>
                        <th>Frequencia</th>
                        <th>Engajamento</th>
                        <th>Financeiro</th>
                        <th>Tenure</th>
                        <th>Ultima Avaliacao</th>
                    </tr>
                </thead>
                <tbody>
                    {% for score in at_risk_students %}
                    <tr>
                        <td>
                            <strong>{{ score.user.name }}</strong>
                            <br><small class="text-muted">{{ score.user.email }}</small>
                        </td>
                        <td>
                            <span class="fw-bold fs-5 {% if score.total_score < 40 %}text-danger{% else %}text-warning{% endif %}">
                                {{ score.total_score|round(0)|int }}
                            </span>
                        </td>
                        <td>
                            {% if score.risk_level.name == 'CRITICAL' %}
                            <span class="badge bg-danger">Critico</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">Alto</span>
                            {% endif %}
                        </td>
                        <td>{{ score.frequency_score|round(0)|int }}/40</td>
                        <td>{{ score.engagement_score|round(0)|int }}/30</td>
                        <td>{{ score.financial_score|round(0)|int }}/20</td>
                        <td>{{ score.tenure_score|round(0)|int }}/10</td>
                        <td>
                            <small>{{ score.calculated_at.strftime('%d/%m/%Y %H:%M') }}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-3x text-success mb-3 d-block"></i>
            <h5 class="text-muted">Nenhum aluno em risco</h5>
            <p class="text-muted">Todos os alunos avaliados possuem score saudavel. Clique em "Calcular Health Scores" para atualizar.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Alert container -->
<div id="retentionAlerts" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
{% endblock %}

{% block extra_js %}
<script>
    function showAlert(message, type) {
        var container = document.getElementById('retentionAlerts');
        var alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
        alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        container.appendChild(alertDiv);
        setTimeout(function() { if (alertDiv.parentNode) alertDiv.remove(); }, 6000);
    }

    function calculateScores() {
        var btn = document.getElementById('btnCalcScores');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calculando...';

        fetch('{{ url_for("crm.calculate_scores") }}', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(function() { location.reload(); }, 2000);
                } else {
                    showAlert(data.error || 'Erro ao calcular', 'danger');
                }
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calculator me-1"></i>Calcular Health Scores';
            })
            .catch(function() {
                showAlert('Erro de conexao', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calculator me-1"></i>Calcular Health Scores';
            });
    }

    function runAutomations() {
        var btn = document.getElementById('btnRunAuto');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Executando...';

        fetch('{{ url_for("crm.run_automations") }}', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    var r = data.results;
                    var details = 'Boas-vindas: ' + r.welcome_sent +
                        ', Recuperacao leve: ' + r.recovery_light_sent +
                        ', Recuperacao critica: ' + r.recovery_critical_sent +
                        ', Ultima tentativa: ' + r.last_attempt_sent +
                        ', Renovacao: ' + r.plan_renewal_sent +
                        ', NPS: ' + r.nps_sent;
                    showAlert('Automacoes executadas! ' + details, 'success');
                } else {
                    showAlert(data.error || 'Erro ao executar', 'danger');
                }
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot me-1"></i>Executar Automacoes';
            })
            .catch(function() {
                showAlert('Erro de conexao', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot me-1"></i>Executar Automacoes';
            });
    }
</script>
{% endblock %}
