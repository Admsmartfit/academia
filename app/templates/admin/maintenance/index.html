{% extends "admin/base.html" %}

{% block page_title %}Manutencao e Backups{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="fas fa-tools me-2"></i>Manutencao e Backups</h4>
    <button class="btn btn-primary" onclick="createBackup()" id="btnCreateBackup">
        <i class="fas fa-download me-1"></i>Criar Backup Agora
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-database me-2"></i>Backups Disponiveis</span>
                <span class="badge bg-secondary">{{ backups|length }} backup(s)</span>
            </div>
            <div class="card-body p-0">
                {% if backups %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Arquivo</th>
                                <th>Tamanho</th>
                                <th>Data de Criacao</th>
                                <th style="width: 120px;">Acoes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for backup in backups %}
                            <tr>
                                <td>
                                    <i class="fas fa-file-archive text-warning me-2"></i>
                                    <code class="small">{{ backup.filename }}</code>
                                </td>
                                <td>{{ backup.size_mb }} MB</td>
                                <td>{{ backup.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="confirmRestore('{{ backup.filename }}')">
                                        <i class="fas fa-undo me-1"></i>Restaurar
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-database fa-3x text-muted mb-3 d-block"></i>
                    <h5 class="text-muted">Nenhum backup encontrado</h5>
                    <p class="text-muted">Clique em "Criar Backup Agora" para gerar o primeiro backup.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <i class="fas fa-info-circle me-2"></i>Informacoes
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li class="mb-2">O sistema mantem automaticamente os <strong>7 backups mais recentes</strong>.</li>
                    <li class="mb-2">Ao restaurar, um <strong>backup de emergencia</strong> do banco atual e criado automaticamente.</li>
                    <li class="mb-2">Apos restaurar, <strong>reinicie a aplicacao</strong> para que as alteracoes tenham efeito.</li>
                    <li>Backups sao armazenados na pasta <code>backups/</code>.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Restauracao</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja restaurar o backup?</p>
                <p class="fw-bold" id="restoreFilename"></p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    O banco de dados atual sera substituido. Um backup de emergencia sera criado automaticamente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmRestore" onclick="executeRestore()">
                    <i class="fas fa-undo me-1"></i>Restaurar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alert container -->
<div id="maintenanceAlerts" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
{% endblock %}

{% block extra_js %}
<script>
    var restoreTarget = '';

    function showAlert(message, type) {
        var container = document.getElementById('maintenanceAlerts');
        var alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
        alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        container.appendChild(alertDiv);
        setTimeout(function() { if (alertDiv.parentNode) alertDiv.remove(); }, 5000);
    }

    function createBackup() {
        var btn = document.getElementById('btnCreateBackup');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Criando...';

        fetch('{{ url_for("admin_maintenance.create_backup") }}', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    showAlert(data.error || 'Erro ao criar backup', 'danger');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-download me-1"></i>Criar Backup Agora';
                }
            })
            .catch(function() {
                showAlert('Erro de conexao', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download me-1"></i>Criar Backup Agora';
            });
    }

    function confirmRestore(filename) {
        restoreTarget = filename;
        document.getElementById('restoreFilename').textContent = filename;
        var modal = new bootstrap.Modal(document.getElementById('restoreModal'));
        modal.show();
    }

    function executeRestore() {
        var btn = document.getElementById('btnConfirmRestore');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Restaurando...';

        fetch('{{ url_for("admin_maintenance.restore_backup") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: restoreTarget })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var modalEl = document.getElementById('restoreModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            if (data.success) {
                showAlert(data.message, 'success');
            } else {
                showAlert(data.error || 'Erro ao restaurar', 'danger');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-undo me-1"></i>Restaurar';
        })
        .catch(function() {
            showAlert('Erro de conexao', 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-undo me-1"></i>Restaurar';
        });
    }
</script>
{% endblock %}
