{% extends "admin/base.html" %}

{% block page_title %}Configuracao WhatsApp (MegaAPI){% endblock %}

{% block content %}
<div class="row">
    <!-- Card 1: Status da Conexao -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="fab fa-whatsapp text-success me-2"></i>
                Status da Conexao
            </div>
            <div class="card-body">
                {% if instance_status.connected %}
                <div class="text-center mb-3">
                    <span class="badge bg-success fs-6 px-3 py-2">
                        <i class="fas fa-check-circle me-1"></i> Conectado
                    </span>
                </div>

                <table class="table table-sm">
                    <tr>
                        <td class="text-muted">Status</td>
                        <td class="fw-bold">{{ instance_status.status }}</td>
                    </tr>
                    {% if instance_status.phone %}
                    <tr>
                        <td class="text-muted">Telefone</td>
                        <td class="fw-bold">{{ instance_status.phone }}</td>
                    </tr>
                    {% endif %}
                    {% if instance_status.name %}
                    <tr>
                        <td class="text-muted">Nome</td>
                        <td class="fw-bold">{{ instance_status.name }}</td>
                    </tr>
                    {% endif %}
                </table>
                {% else %}
                <div class="text-center mb-3">
                    <span class="badge bg-danger fs-6 px-3 py-2">
                        <i class="fas fa-times-circle me-1"></i> Desconectado
                    </span>
                </div>

                {% if instance_status.error %}
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {{ instance_status.error }}
                </div>
                {% endif %}
                {% endif %}

                <div class="mt-3 text-center">
                    <a href="{{ url_for('admin_megaapi.settings') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync-alt me-1"></i> Atualizar Status
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 2: Credenciais -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-key text-warning me-2"></i>
                Credenciais
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin_megaapi.settings') }}">
                    <input type="hidden" name="action" value="save_config">

                    <div class="mb-3">
                        <label for="host" class="form-label">Host (URL da API)</label>
                        <input type="url" class="form-control" id="host" name="host" value="{{ current_host }}"
                            placeholder="https://api.megaapi.com.br/v1">
                        <div class="form-text">URL base da API MegaAPI</div>
                    </div>

                    <div class="mb-3">
                        <label for="instance_key" class="form-label">Instance Key</label>
                        <input type="text" class="form-control" id="instance_key" name="instance_key"
                            value="{{ current_instance_key }}" placeholder="sua-instance-key">
                        <div class="form-text">Chave da instancia WhatsApp</div>
                    </div>

                    <div class="mb-3">
                        <label for="token" class="form-label">Token (Bearer)</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="token" name="token"
                                value="{{ current_token }}" placeholder="seu-token-secreto">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="togglePasswordVisibility('token', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Token de autenticacao da API</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-success font-monospace" id="validateBtn"
                            onclick="validateConnection()">
                            <i class="fas fa-plug me-1"></i> Validar Agora
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Salvar Config
                        </button>
                    </div>
                </form>

                <div class="alert alert-info mt-3 mb-0 small">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Nota:</strong> As configuracoes sao salvas em memoria.
                    Para persistir, defina as variaveis de ambiente:
                    <code>MEGAAPI_BASE_URL</code>, <code>MEGAAPI_TOKEN</code>, <code>MEGAAPI_INSTANCE_KEY</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 3: Teste de Envio -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-paper-plane text-info me-2"></i>
                Teste de Envio
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin_megaapi.settings') }}">
                    <input type="hidden" name="action" value="send_test">

                    <div class="mb-3">
                        <label for="test_phone" class="form-label">Numero de Telefone</label>
                        <input type="tel" class="form-control" id="test_phone" name="test_phone"
                            placeholder="11999999999" required>
                        <div class="form-text">Formato: DDD + numero (sem espacos)</div>
                    </div>

                    <div class="mb-3">
                        <label for="test_message" class="form-label">Mensagem</label>
                        <textarea class="form-control" id="test_message" name="test_message" rows="4" required
                            placeholder="Digite sua mensagem de teste aqui..."></textarea>
                        <div class="form-text">Mensagem de texto simples para teste</div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success" {% if not instance_status.connected %}disabled{%
                            endif %}>
                            <i class="fab fa-whatsapp me-1"></i> Enviar Teste
                        </button>
                    </div>

                    {% if not instance_status.connected %}
                    <div class="alert alert-warning mt-3 mb-0 small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Configure as credenciais e verifique a conexao antes de testar.
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Informacoes Adicionais -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-book text-secondary me-2"></i>
                Documentacao Rapida
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Formato do Telefone</h6>
                        <ul class="small text-muted">
                            <li>Use apenas numeros</li>
                            <li>DDD + numero: <code>11999999999</code></li>
                            <li>O sistema adiciona <code>55</code> automaticamente</li>
                            <li>Formato final: <code>5511999999999</code></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Janela de Mensagens</h6>
                        <ul class="small text-muted">
                            <li>Mensagens de texto simples funcionam apenas dentro da janela de 24h</li>
                            <li>Para mensagens fora da janela, use templates aprovados</li>
                            <li>Gerencie templates em: <a href="{{ url_for('admin_whatsapp.list_templates') }}">WhatsApp
                                    Templates</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function validateConnection() {
        const btn = document.getElementById('validateBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Validando...';

        const data = {
            host: document.getElementById('host').value,
            instance_key: document.getElementById('instance_key').value,
            token: document.getElementById('token').value
        };

        fetch('{{ url_for("admin_megaapi.check_status_ajax") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.connected) {
                    alert('✅ Sucesso! Conectado: ' + (data.status || 'OK'));
                    location.reload(); // Refresh to update status card
                } else {
                    alert('❌ Falha na conexão: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(err => {
                alert('❌ Erro de requisição: ' + err);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }
</script>
{% endblock %}